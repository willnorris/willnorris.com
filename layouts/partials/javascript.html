<script type="module">
  document.addEventListener("DOMContentLoaded", function() {
    // set scrollbar width CSS variable
    document.documentElement.style.setProperty('--scrollbar-width', window.innerWidth - document.documentElement.clientWidth + 'px');

    // load fragmention if URL fragment is present
    (async () => {
      if (window.location.hash !== "") {
        await import({{ (resources.Get "js/fragmention.js" | resources.Fingerprint).RelPermalink }})
      }
    })();

    (async () => {
      const links = document.querySelectorAll("a[href^=http]")
      if (links.length) {
        await import({{ (resources.Get "js/unrot.js" | resources.Fingerprint).RelPermalink }})
      }
    })();

    // display popover for linked images
    (async () => {
      if (!HTMLElement.prototype.hasOwnProperty("popover")) {
        // https://caniuse.com/popover
        if (navigator.userAgent.includes("Firefox")) {
          console.log("This page uses popovers. You can enable them in Firefox by setting 'dom.element.popover.enabled' to true in 'about:config'");
        }
        return
      }
      const imageAnchors = Array.from(document.querySelectorAll('.e-content a'))
          .filter(a => a.href.match(/.(jpg|jpeg|png|webp)$/))
          .filter(a => a.querySelector('img'))
      if (imageAnchors.length) {
        const popover = document.createElement("div");
        popover.setAttribute("popover", "");
        const img = document.createElement("img");
        popover.appendChild(img);
        document.body.append(popover);

        for(const a of imageAnchors) {
          a.addEventListener("click", (event) => {
            event.preventDefault();
            img.src = ""; // prevent flash of previous image
            img.src = a.href;
            console.log(popover);
            popover.showPopover();
          });
        }

        let lastScrollY = window.scrollY;
        window.addEventListener("scroll", (event) => {
          const deltaS = window.scrollY - lastScrollY;
          lastScrollY = window.scrollY;
          // close popover if scrolled more than 10px
          if (Math.abs(deltaS) > 10) {
            popover.hidePopover();
          }
        });
      }
    })();

    // display galleries in masonry grid
    (async () => {
      const galleries = document.querySelectorAll('.gallery')
      if (galleries.length && !CSS.supports("grid-template-rows", "masonry")) {
        // fallback to use macy.js to display masonry grid if needed
        const {default:macy} = await import({{ (resources.Get "js/macy.mjs" | resources.Fingerprint).RelPermalink }})
        macy({
            container: '.gallery',
            mobileFirst: true,
            columns: 1,
            margin: 5,
            breakAt: {
                450: { columns: 2 },
                700: { columns: 3, margin: 10 },
                850: { columns: 4 }
            },
          })
      }
    })();

    // webmention form handler
    (async () => {
      const form = document.getElementById("webmention-form");
      if (form) {
        const result = form.querySelector("[result]");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const params = new URLSearchParams();
          params.set("source", form.querySelector("[name=source]").value);
          params.set("target", form.querySelector("[name=target]").value);

          console.log("submitted form with params", params)
          const response = await fetch(form.action, { method: "post", body: params });
          if (response.ok) {
            const data = await response.json();
            result.className = "success";
            result.innerText = data.summary;
          } else {
            result.className = "error";
            result.innerText = "Error: " + response.statusText;
          }
        });
      }
    })();
  })
</script>
